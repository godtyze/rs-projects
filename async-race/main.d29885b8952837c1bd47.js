(()=>{"use strict";var e={};e.g=function(){if("object"==typeof globalThis)return globalThis;try{return this||new Function("return this")()}catch(e){if("object"==typeof window)return window}}(),(()=>{var t;e.g.importScripts&&(t=e.g.location+"");var n=e.g.document;if(!t&&n&&(n.currentScript&&(t=n.currentScript.src),!t)){var i=n.getElementsByTagName("script");i.length&&(t=i[i.length-1].src)}if(!t)throw new Error("Automatic publicPath is not supported in this browser");t=t.replace(/#.*$/,"").replace(/\?.*$/,"").replace(/\/[^\/]+$/,"/"),e.p=t})();class t{constructor(e,t=[],n=""){const i=document.createElement(e);i.classList.add(...t),i.textContent=n,this.element=i}}class n extends t{constructor(e,t,n=!1){super("button",["btn",...t],e),n&&this.element.setAttribute("disabled","")}}class i extends t{constructor(){super("nav",["header__nav","nav"]),this.garageBtn=new n("Garage",["nav__btn","active"]),this.winnersBtn=new n("Winners",["nav__btn"]),this.element.append(this.garageBtn.element,this.winnersBtn.element)}}class a extends t{constructor(){super("header",["header"]),this.navigation=new i;const e=new t("h1",["header__title"],"Async Race").element;this.element.append(this.navigation.element,e)}}class s extends t{constructor(){super("div",["footer"]);const e=new t("a",["footer__link-github"]).element;e.setAttribute("href","https://github.com/godtyze"),e.setAttribute("target","_blank");const n=new t("span",[],"2022").element,i=new t("a",["footer__link-rs"]).element;i.setAttribute("href","https://rs.school/"),i.setAttribute("target","_blank"),this.element.append(e,n,i)}}class r extends t{constructor(e,t=[],n){super("input",[...t]),this.element.setAttribute("type",e),n&&this.element.setAttribute("placeholder",n)}}const o=e.p+"assets/90b4fe8c818ec239bd7f.svg";var d=function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};const l=["Tesla","Mersedes","BMW","Toyota","Zhiguli","Moskvich","Opel","Aston Martin","Porshe","Lada"],c=["Model S","CLK","7","Camry","Combi","9","Corsa","DB9","Cayene","Calina"],u=()=>{const e="0123456789ABCDEF";let t="#";for(let n=0;n<6;n++)t+=e[Math.floor(Math.random()*e.length)];return t},h=e=>{e.forEach((e=>e.setAttribute("disabled","")))},p=e=>{e.forEach((e=>e.removeAttribute("disabled")))},m=(e,n)=>{const i=new t("div",["car__img"]).element;return i.innerHTML=`<svg class="car" id="car-${n}" width="100" height="35"><use xlink:href="${o}#car-02" fill="${e}"></use></svg>`,i},v=e=>d(void 0,void 0,void 0,(function*(){const{velocity:t,distance:n}=yield C(e,"started"),i=Math.floor(n/t),a=document.getElementById(`car-${e}`);if(!a)throw new Error("no such car!");b.animation[e]=((e,t,n)=>{let i;const a={step:0},s=e=>{i||(i=e);const r=100*(e-i)/n;t.style.left=`${Math.min(r,100)}%`,r<100&&(a.step=window.requestAnimationFrame(s))};return a.step=window.requestAnimationFrame(s),a})(0,a,i);const s=yield B(e);return s.success||window.cancelAnimationFrame(b.animation[e].step),{success:s.success,id:e,animationTime:i}})),g=e=>d(void 0,void 0,void 0,(function*(){const t=document.getElementById(`car-${e}`);yield C(e,"stopped"),window.cancelAnimationFrame(b.animation[e].step),t&&(t.style.left="0")})),w="http://127.0.0.1:3000";var f=function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};const y={garage:`${w}/garage`,winners:`${w}/winners`,engine:`${w}/engine`},_=e=>f(void 0,void 0,void 0,(function*(){yield fetch(y.garage,{method:"POST",body:JSON.stringify(e),headers:new Headers({"Content-type":"application/json"})})})),C=(e,t)=>f(void 0,void 0,void 0,(function*(){const n=yield fetch(`${y.engine}?id=${e}&status=${t}`,{method:"PATCH"}),i=yield n.json();return{velocity:i.velocity,distance:i.distance}})),B=e=>f(void 0,void 0,void 0,(function*(){const t=yield fetch(`${y.engine}?id=${e}&status=drive`,{method:"PATCH"});return 200===t.status?Object.assign({},yield t.json()):{success:!1}}));class b{static getValues(){return e=this,t=void 0,i=function*(){const e=yield((e,t=7)=>f(void 0,void 0,void 0,(function*(){const n=yield fetch(`${y.garage}?_page=${e}&_limit=${t}`);return{items:yield n.json(),count:+(n.headers.get("X-Total-Count")||0)}})))(b.garagePage);b.cars=e.items,b.carsCount=e.count;const t=yield((e,t,n,i=10)=>f(void 0,void 0,void 0,(function*(){const a=yield fetch(`${y.winners}?_page=${e}&_limit=${i}${((e,t)=>e&&t?`&_sort=${e}&_order=${t}`:"")(t,n)}`);return{items:yield a.json(),count:+(a.headers.get("X-Total-Count")||0)}})))(b.winnersPage,b.sort,b.order);b.winners=t.items,b.winnersCount=t.count,this.onWinnersUpdate&&this.onWinnersUpdate()},new((n=void 0)||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}));var e,t,n,i}}b.garagePage=1,b.winnersPage=1,b.createInputTextValue="",b.createInputColorValue="",b.sort="",b.order="",b.updateInputTextValue="",b.updateInputColorValue="",b.cars=[],b.carsCount=0,b.animation={},b.winners=[],b.winnersCount=0;class x extends t{constructor(){super("div",["garage__inputs"]),this.getUpdatedInputValues=()=>{if(!b.selectedCar)throw new Error("There's no selected car");return{name:b.updateInputTextValue,color:b.updateInputColorValue}},this.createInputText=new r("text",["inputs__create-name"],"Input car name"),this.createInputColor=new r("color",["inputs__create-color"]),this.createCarButton=new n("Create",["inputs__create-btn"],!0),this.updateInputText=new r("text",["inputs__update-name"],"Input car name"),this.updateInputColor=new r("color",["inputs__update-color"]),this.updateCarButton=new n("Update",["inputs__update-btn"],!0),this.startRaceButton=new n("Start race",["garage__btn"]),this.resetRaceButton=new n("Reset race",["garage__btn","reset"],!0),this.generateCarsButton=new n("100 Random cars",["garage__btn"]),this.render()}render(){const e=[this.createInputText,this.createInputColor,this.createCarButton],n=[this.updateInputText,this.updateInputColor,this.updateCarButton],i=[this.startRaceButton,this.resetRaceButton,this.generateCarsButton],a=new t("div",["garage__inputs-create"]);e.forEach((e=>a.element.append(e.element)));const s=new t("div",["garage__inputs-update"]);n.forEach((e=>s.element.append(e.element)));const r=new t("div",["garage__inputs"]);r.element.append(a.element,s.element);const o=new t("div",["garage__buttons"]);i.forEach((e=>o.element.append(e.element))),this.createInputHandler(),this.element.append(r.element,o.element)}createInputHandler(){this.createInputText.element.addEventListener("input",(()=>{const e=this.createInputText.element;b.createInputTextValue=e.value.trim(),p([this.createCarButton.element]),b.createInputTextValue||h([this.createCarButton.element])})),this.createInputColor.element.addEventListener("input",(()=>{const e=this.createInputColor.element;b.createInputColorValue=e.value}))}updateInputHandler(e){this.updateInputText.element.value=e.name,b.updateInputTextValue=e.name,this.updateInputColor.element.value=e.color,b.updateInputColorValue=e.color,p([this.updateCarButton.element]),this.updateInputText.element.addEventListener("input",(()=>{const e=this.updateInputText.element;b.updateInputTextValue=e.value.trim(),e.value||h([this.updateCarButton.element])})),this.updateInputColor.element.addEventListener("input",(()=>{const e=this.updateInputColor.element;b.updateInputColorValue=e.value}))}getCreateInputValues(){return{name:b.createInputTextValue,color:b.createInputColorValue}}}var T=function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class I extends t{constructor(e,t=(()=>{}),i=(()=>{})){super("div",["car__wrapper"]),this.car=e,this.name=e.name,this.color=e.color,this.id=e.id,this.selectButton=new n("Select",["car__btn"]),this.removeButton=new n("Remove",["car__btn"]),this.startButton=new n("Start",["car__btn"]),this.resetButton=new n("Reset",["car__btn","reset"],!0),this.carWrapper=m(this.color,this.id),this.selectButton.element.addEventListener("click",(()=>t(this.car))),this.removeButton.element.addEventListener("click",(()=>i(this.car))),this.render()}render(){const e=new t("div",["car__race-buttons"]).element,n=new t("h3",["car__name"],this.car.name).element;[this.startButton.element,this.resetButton.element,n].forEach((t=>e.append(t)));const i=new t("div",["car__settings-buttons"]).element;[this.selectButton.element,this.removeButton.element].forEach((e=>i.append(e)));const a=new t("div",["car__container"]).element;a.append(i,this.carWrapper),this.handleStartButton(),this.handleResetButton(),this.element.append(n,e,a)}handleStartButton(){this.startButton.element.addEventListener("click",(()=>T(this,void 0,void 0,(function*(){p([this.resetButton.element]),h([this.startButton.element,this.selectButton.element,this.removeButton.element]),yield v(+this.id)}))))}handleResetButton(){this.resetButton.element.addEventListener("click",(()=>T(this,void 0,void 0,(function*(){yield g(+this.id),p([this.startButton.element,this.selectButton.element,this.removeButton.element]),h([this.resetButton.element])}))))}}class E extends t{constructor(e=(()=>{}),t=(()=>{})){super("div",["garage__cars-field"]),b.cars.forEach((n=>this.element.append(new I(n,e,t).element)))}}class P extends t{constructor(e){super("div",[...e,"pages"]),this.nextPageBtn=new n(">",["btn","pages__btn-next"]),this.prevPageBtn=new n("<",["btn","pages__btn-prev"]),this.pageCounter=new t("p",["pages__counter"],`Page #${"garage__pages"===e.join("")?b.garagePage:b.winnersPage}`),this.render()}render(){const e=new t("div",["pages__buttons"]).element;e.append(this.prevPageBtn.element,this.nextPageBtn.element),this.element.append(this.pageCounter.element,e)}}class $ extends t{constructor(){super("div",["modal-window"]),this.overlay=new t("div",["overlay","active"]),this.modalWindowMain=new t("div",["modal-window__main"]),this.modalWindowBtn=new n("✖",["modal-window__btn"])}render(e){this.overlay.element.addEventListener("click",(()=>this.remove())),this.modalWindowBtn.element.addEventListener("click",(()=>this.remove())),this.modalWindowMain.element.textContent=e,this.element.append(this.modalWindowBtn.element,this.modalWindowMain.element),document.body.prepend(this.overlay.element,this.element)}remove(){this.element.remove(),this.overlay.element.remove()}}var F=function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class V extends t{constructor(){super("section",["garage"]),this.inputsField=new x,this.carsCounter=new t("h2",["garage__title"],`Cars in garage: ${b.carsCount}`),this.carsField=new E,this.pagesField=new P(["garage__pages"]),this.modalWindow=new $,this.handleCreateCarBtn(),this.handleUpdateCarBtn(),this.handleCreateRandomCarsBtn(),this.handleRaceBtn(),this.handleResetBtn(),this.handlePageButtons(),this.render()}render(){this.element.innerHTML="",this.carsField=new E((e=>{b.selectedCar=e,this.inputsField.updateInputHandler(e)}),(e=>{var t;(t=+e.id,f(void 0,void 0,void 0,(function*(){yield fetch(`${y.garage}/${t}`,{method:"DELETE"})}))).then((()=>F(this,void 0,void 0,(function*(){yield(e=>f(void 0,void 0,void 0,(function*(){yield fetch(`${y.winners}/${e}`,{method:"DELETE"})})))(+e.id),yield b.getValues(),this.render()}))))})),this.carsCounter=new t("h2",["garage__title"],`Cars in garage: ${b.carsCount}`),this.pagesField=new P(["garage__pages"]),this.handlePageButtons(),this.element.append(this.inputsField.element,this.carsCounter.element,this.pagesField.element,this.carsField.element)}handleCreateCarBtn(){this.inputsField.createCarButton.element.addEventListener("click",(()=>{const e=this.inputsField.getCreateInputValues();_(e).then((()=>F(this,void 0,void 0,(function*(){yield b.getValues(),this.inputsField.createInputText.element.value="",this.inputsField.createInputColor.element.value="#000000",b.createInputTextValue="",b.createInputColorValue="#000000",h([this.inputsField.createCarButton.element]),this.render()}))))}))}handleUpdateCarBtn(){this.inputsField.updateCarButton.element.addEventListener("click",(()=>{const e=this.inputsField.getUpdatedInputValues();var t,n;b.selectedCar&&(t=+b.selectedCar.id,n=e,f(void 0,void 0,void 0,(function*(){yield fetch(`${y.garage}/${t}`,{method:"PUT",body:JSON.stringify(n),headers:new Headers({"Content-type":"application/json"})})}))).then((()=>F(this,void 0,void 0,(function*(){yield b.getValues(),b.selectedCar=void 0,this.inputsField.updateInputText.element.value="",this.inputsField.updateInputColor.element.value="#000000",b.updateInputTextValue="",b.updateInputColorValue="#000000",h([this.inputsField.updateCarButton.element]),this.render()}))))}))}handleCreateRandomCarsBtn(){this.inputsField.generateCarsButton.element.addEventListener("click",(()=>F(this,void 0,void 0,(function*(){const e=new Array(100).fill(0).map((()=>({name:`${l[Math.floor(Math.random()*l.length)]} ${c[Math.floor(Math.random()*c.length)]}`,color:u()})));yield e.forEach((e=>_(e))),yield b.getValues(),this.render()}))))}handleRaceBtn(){this.inputsField.startRaceButton.element.addEventListener("click",(()=>F(this,void 0,void 0,(function*(){let e=!1;document.querySelectorAll(".btn").forEach((e=>h([e])));const t=yield Promise.all(b.cars.map((t=>F(this,void 0,void 0,(function*(){const n=yield v(+t.id);if(n.success&&!e){p([this.inputsField.resetRaceButton.element]);const t=n.animationTime/1e3,i=b.cars.find((e=>+e.id===n.id));yield this.addWinnerToTable(n,t,i),this.handleModalWindow(!0,i,t),e=!0}return n.success})))));t.every((e=>!e))&&(this.handleModalWindow(!1),p([this.inputsField.resetRaceButton.element]))}))))}handleResetBtn(){this.inputsField.resetRaceButton.element.addEventListener("click",(()=>F(this,void 0,void 0,(function*(){yield Promise.all(b.cars.map((e=>g(+e.id)))),document.querySelectorAll(".btn").forEach((e=>{e.classList.contains("reset")||p([e])})),h([this.inputsField.resetRaceButton.element])}))))}handlePageButtons(){this.pagesField.prevPageBtn.element.addEventListener("click",(()=>F(this,void 0,void 0,(function*(){1!==b.garagePage&&(b.garagePage--,yield b.getValues(),this.render())})))),this.pagesField.nextPageBtn.element.addEventListener("click",(()=>F(this,void 0,void 0,(function*(){7*b.garagePage<b.carsCount&&(b.garagePage++,yield b.getValues(),this.render())}))))}handleModalWindow(e=!0,t,n){const i=e?`${null==t?void 0:t.name} won with ${n}s`:"All cars are broken";this.modalWindow.render(i)}addWinnerToTable(e,t,n){return F(this,void 0,void 0,(function*(){let i=b.winners.find((t=>+t.id===e.id));var a;!i&&n?(i={id:+n.id,wins:1,time:t},yield(a=i,f(void 0,void 0,void 0,(function*(){yield fetch(y.winners,{method:"POST",body:JSON.stringify(a),headers:new Headers({"Content-type":"application/json"})})}))),yield b.getValues()):i&&(i.wins++,i.time>t&&(i.time=t),yield((e,t)=>f(void 0,void 0,void 0,(function*(){yield fetch(`${y.winners}/${e}`,{method:"PUT",body:JSON.stringify(t),headers:new Headers({"Content-type":"application/json"})})})))(i.id,i),yield b.getValues())}))}}class L extends t{constructor(){super("div",["row"])}render(e,n,i){const a=new t("div",["row-number"],`${e}`).element,s=m(i.color,i.id),r=new t("div",["row-name"],i.name).element,o=new t("div",["row-wins"],`${n.wins}`).element,d=new t("div",["row-time"],`${n.time}`).element;return this.element.append(a,s,r,o,d),this}}class W extends t{constructor(){super("div",["winners__table"]),this.render().catch()}render(){return e=this,t=void 0,i=function*(){(yield Promise.all(b.winners.map((e=>{return t=e.id,f(void 0,void 0,void 0,(function*(){const e=yield fetch(`${y.garage}/${t}`),n=yield e.json();return{name:n.name,color:n.color,id:n.id}}));var t})))).forEach(((e,t)=>{const n=10*(b.winnersPage-1)+(t+1),i=(new L).render(n,b.winners[t],e).element;this.element.append(i)}))},new((n=void 0)||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}));var e,t,n,i}}var A=function(e,t,n,i){return new(n||(n=Promise))((function(a,s){function r(e){try{d(i.next(e))}catch(e){s(e)}}function o(e){try{d(i.throw(e))}catch(e){s(e)}}function d(e){var t;e.done?a(e.value):(t=e.value,t instanceof n?t:new n((function(e){e(t)}))).then(r,o)}d((i=i.apply(e,t||[])).next())}))};class k extends t{constructor(){super("section",["winners"]),this.winnersTable=new W,this.winnersCounter=new t("h2",["winners__title"],`Winners: ${b.winnersCount}`),this.pagesField=new P(["winners__pages"]),this.totalWins=new t("div",["table-header__wins"],"Wins Counter"),this.bestTime=new t("div",["table-header__best-time"],"Best time"),b.onWinnersUpdate=()=>{this.render()},this.render()}render(){this.element.innerHTML="",this.pagesField=new P(["winners__pages"]),this.winnersCounter=new t("h2",["winners__title"],`Winners: ${b.winnersCount}`),this.totalWins=new t("div",["table-header__wins"],"Wins Counter"),this.bestTime=new t("div",["table-header__best-time"],"Best time"),this.winnersTable=new W;const e=new t("div",["table-header__num"],"№").element,n=new t("div",["table-header__image"],"Car image").element,i=new t("div",["table-header__name"],"Car name").element,a=new t("div",["table-header"]).element;a.append(e,n,i,this.totalWins.element,this.bestTime.element),this.handleSortTable(),this.handlePageButtons(),this.element.append(this.winnersCounter.element,this.pagesField.element,a,this.winnersTable.element)}handleSortTable(){this.totalWins.element.addEventListener("click",(()=>A(this,void 0,void 0,(function*(){b.order="ASC"===b.order?"DESC":"ASC",b.sort="wins",yield b.getValues(),this.render()})))),this.bestTime.element.addEventListener("click",(()=>A(this,void 0,void 0,(function*(){b.order="ASC"===b.order?"DESC":"ASC",b.sort="time",yield b.getValues(),this.render()}))))}handlePageButtons(){this.pagesField.prevPageBtn.element.addEventListener("click",(()=>A(this,void 0,void 0,(function*(){1!==b.winnersPage&&(b.winnersPage--,yield b.getValues(),this.render())})))),this.pagesField.nextPageBtn.element.addEventListener("click",(()=>A(this,void 0,void 0,(function*(){10*b.winnersPage<b.winnersCount&&(b.winnersPage++,yield b.getValues(),this.render())}))))}}class S extends t{constructor(){super("main",["main"]),this.garage=new V,this.winners=new k,this.render()}render(){this.element.append(this.garage.element,this.winners.element)}}(new class{constructor(){this.header=new a,this.footer=new s}init(){return e=this,n=void 0,a=function*(){try{document.body.prepend(this.header.element,this.footer.element),yield b.getValues(),this.main=new S,this.header.element.after(this.main.element),this.switchPagesHandler()}catch(e){const n=new t("p",["error"],"No connection to the server!").element;this.header.element.after(n)}},new((i=void 0)||(i=Promise))((function(t,s){function r(e){try{d(a.next(e))}catch(e){s(e)}}function o(e){try{d(a.throw(e))}catch(e){s(e)}}function d(e){var n;e.done?t(e.value):(n=e.value,n instanceof i?n:new i((function(e){e(n)}))).then(r,o)}d((a=a.apply(e,n||[])).next())}));var e,n,i,a}switchPagesHandler(){this.header.navigation.garageBtn.element.addEventListener("click",(()=>{this.header.navigation.garageBtn.element.classList.add("active"),this.header.navigation.winnersBtn.element.classList.remove("active"),this.main&&(this.main.winners.element.style.display="none",this.main.garage.element.style.display="flex")})),this.header.navigation.winnersBtn.element.addEventListener("click",(()=>{this.header.navigation.winnersBtn.element.classList.add("active"),this.header.navigation.garageBtn.element.classList.remove("active"),this.main&&(this.main.winners.element.style.display="flex",this.main.garage.element.style.display="none")}))}}).init()})();
//# sourceMappingURL=main.d29885b8952837c1bd47.js.map